generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int               @id @default(autoincrement())
  username        String            @unique
  password        String
  name            String
  role            Role              @default(TECHNICIAN)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  Appointment     Appointment[]
  receptionJobs   Job[]             @relation("ReceptionJobs")
  technicianJobs  Job[]             @relation("TechnicianJobs")
  LaborTime       LaborTime[]
  PartRequisition PartRequisition[]
  Quotation       Quotation[]
}

model Customer {
  id              Int               @id @default(autoincrement())
  phoneNumber     String            @unique
  title           String?
  firstName       String
  lastName        String
  address         String?
  taxId           String?
  points          Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  motorcycles     Motorcycle[]
  Payment         Payment[]
  Quotation       Quotation[]
  ServiceReminder ServiceReminder[]
}

model Motorcycle {
  id              Int               @id @default(autoincrement())
  vin             String            @unique
  licensePlate    String
  brand           String
  model           String
  color           String
  year            Int?
  engineNo        String?
  ownerId         Int
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  mileage         Int?              @default(0)
  Appointment     Appointment[]
  jobs            Job[]
  owner           Customer          @relation(fields: [ownerId], references: [id])
  Quotation       Quotation[]
  ServiceReminder ServiceReminder[]
  Warranty        Warranty[]
}

model Job {
  id               Int                @id @default(autoincrement())
  jobNo            String             @unique
  symptom          String
  fuelLevel        Int?
  valuables        String?
  status           JobStatus          @default(PENDING)
  jobType          JobType            @default(NORMAL)
  motorcycleId     Int
  receptionId      Int?
  technicianId     Int?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  appointmentId    Int?               @unique
  completedAt      DateTime?
  diagnosisNotes   String?
  quotationId      Int?               @unique
  startedAt        DateTime?
  warrantyId       Int?               @unique
  Appointment      Appointment?       @relation(fields: [appointmentId], references: [id])
  motorcycle       Motorcycle         @relation(fields: [motorcycleId], references: [id])
  Quotation        Quotation?         @relation(fields: [quotationId], references: [id])
  reception        User?              @relation("ReceptionJobs", fields: [receptionId], references: [id])
  technician       User?              @relation("TechnicianJobs", fields: [technicianId], references: [id])
  Warranty         Warranty?          @relation(fields: [warrantyId], references: [id])
  JobChecklistItem JobChecklistItem[]
  LaborTime        LaborTime[]
  Outsource        Outsource[]
  PartRequisition  PartRequisition[]
  Payment          Payment?
}

model Appointment {
  id            Int               @id @default(autoincrement())
  appointmentNo String            @unique
  motorcycleId  Int
  scheduledDate DateTime
  scheduledTime String
  status        AppointmentStatus @default(SCHEDULED)
  notes         String?
  scheduledById Int
  jobId         Int?              @unique
  createdAt     DateTime          @default(now())
  updatedAt     DateTime
  Motorcycle    Motorcycle        @relation(fields: [motorcycleId], references: [id])
  User          User              @relation(fields: [scheduledById], references: [id])
  Job           Job?
}

model JobChecklistItem {
  id        Int      @id @default(autoincrement())
  jobId     Int
  itemName  String
  condition String
  notes     String?
  createdAt DateTime @default(now())
  Job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model LaborTime {
  id              Int       @id @default(autoincrement())
  jobId           Int
  technicianId    Int
  taskDescription String
  standardMinutes Int?
  actualMinutes   Int
  hourlyRate      Decimal   @db.Decimal(10, 2)
  laborCost       Decimal   @db.Decimal(10, 2)
  startedAt       DateTime?
  pausedAt        DateTime?
  resumedAt       DateTime?
  finishedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  Job             Job       @relation(fields: [jobId], references: [id])
  User            User      @relation(fields: [technicianId], references: [id])
}

model LostSale {
  id           Int      @id @default(autoincrement())
  partId       Int
  quantity     Int
  unitPrice    Decimal  @db.Decimal(10, 2)
  totalValue   Decimal  @db.Decimal(10, 2)
  customerInfo String?
  notes        String?
  createdAt    DateTime @default(now())
  Part         Part     @relation(fields: [partId], references: [id])
}

model Outsource {
  id              Int       @id @default(autoincrement())
  jobId           Int
  vendorName      String
  workDescription String
  cost            Decimal   @db.Decimal(10, 2)
  sellingPrice    Decimal   @db.Decimal(10, 2)
  estimatedDays   Int?
  completedAt     DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  Job             Job       @relation(fields: [jobId], references: [id])
}

model Part {
  id                  Int                   @id @default(autoincrement())
  partNo              String                @unique
  name                String
  description         String?
  brand               String?
  category            String?
  unit                String                @default("ชิ้น")
  unitPrice           Decimal               @db.Decimal(10, 2)
  stockQuantity       Int                   @default(0)
  reorderPoint        Int                   @default(0)
  reorderQuantity     Int                   @default(0)
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  LostSale            LostSale[]
  PartPackageItem     PartPackageItem[]
  PartRequisitionItem PartRequisitionItem[]
  QuotationItem       QuotationItem[]
  StockMovement       StockMovement[]
}

model PartPackage {
  id                  Int                   @id @default(autoincrement())
  packageNo           String                @unique
  name                String
  description         String?
  sellingPrice        Decimal               @db.Decimal(10, 2)
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  PartPackageItem     PartPackageItem[]
  PartRequisitionItem PartRequisitionItem[]
  QuotationItem       QuotationItem[]
}

model PartPackageItem {
  id          Int         @id @default(autoincrement())
  packageId   Int
  partId      Int
  quantity    Int         @default(1)
  createdAt   DateTime    @default(now())
  PartPackage PartPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  Part        Part        @relation(fields: [partId], references: [id])
}

model PartRequisition {
  id                  Int                   @id @default(autoincrement())
  reqNo               String                @unique
  jobId               Int?
  requestedById       Int
  status              PartRequisitionStatus @default(PENDING)
  notes               String?
  approvedAt          DateTime?
  issuedAt            DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  Job                 Job?                  @relation(fields: [jobId], references: [id])
  User                User                  @relation(fields: [requestedById], references: [id])
  PartRequisitionItem PartRequisitionItem[]
}

model PartRequisitionItem {
  id                Int             @id @default(autoincrement())
  requisitionId     Int
  partId            Int?
  packageId         Int?
  quantity          Int
  requestedQuantity Int
  issuedQuantity    Int             @default(0)
  notes             String?
  createdAt         DateTime        @default(now())
  PartPackage       PartPackage?    @relation(fields: [packageId], references: [id])
  Part              Part?           @relation(fields: [partId], references: [id])
  PartRequisition   PartRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
}

model Payment {
  id            Int           @id @default(autoincrement())
  paymentNo     String        @unique
  jobId         Int           @unique
  customerId    Int
  subtotal      Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  pointsUsed    Int           @default(0)
  pointsEarned  Int           @default(0)
  vat           Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount   Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  Customer      Customer      @relation(fields: [customerId], references: [id])
  Job           Job           @relation(fields: [jobId], references: [id])
}

model Quotation {
  id            Int             @id @default(autoincrement())
  quotationNo   String          @unique
  customerId    Int
  motorcycleId  Int
  status        QuotationStatus @default(DRAFT)
  totalAmount   Decimal         @default(0) @db.Decimal(10, 2)
  validUntil    DateTime?
  notes         String?
  createdById   Int
  jobId         Int?            @unique
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  Job           Job?
  User          User            @relation(fields: [createdById], references: [id])
  Customer      Customer        @relation(fields: [customerId], references: [id])
  Motorcycle    Motorcycle      @relation(fields: [motorcycleId], references: [id])
  QuotationItem QuotationItem[]
}

model QuotationItem {
  id          Int          @id @default(autoincrement())
  quotationId Int
  itemType    String
  itemName    String
  quantity    Int          @default(1)
  unitPrice   Decimal      @db.Decimal(10, 2)
  totalPrice  Decimal      @db.Decimal(10, 2)
  partId      Int?
  packageId   Int?
  createdAt   DateTime     @default(now())
  PartPackage PartPackage? @relation(fields: [packageId], references: [id])
  Part        Part?        @relation(fields: [partId], references: [id])
  Quotation   Quotation    @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model ServiceReminder {
  id                 Int        @id @default(autoincrement())
  customerId         Int
  motorcycleId       Int
  reminderType       String
  dueMileage         Int?
  dueDate            DateTime?
  intervalMiles      Int?
  intervalDays       Int?
  lastServiceMileage Int?
  lastServiceDate    DateTime?
  isActive           Boolean    @default(true)
  notified           Boolean    @default(false)
  notifiedAt         DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime
  Customer           Customer   @relation(fields: [customerId], references: [id])
  Motorcycle         Motorcycle @relation(fields: [motorcycleId], references: [id])
}

model StockMovement {
  id           Int               @id @default(autoincrement())
  partId       Int
  movementType StockMovementType
  quantity     Int
  unitPrice    Decimal?          @db.Decimal(10, 2)
  reference    String?
  notes        String?
  createdAt    DateTime          @default(now())
  createdById  Int?
  Part         Part              @relation(fields: [partId], references: [id])
}

model Warranty {
  id             Int            @id @default(autoincrement())
  warrantyNo     String         @unique
  motorcycleId   Int
  jobId          Int?           @unique
  startDate      DateTime
  endDate        DateTime
  mileageLimit   Int?
  currentMileage Int            @default(0)
  status         WarrantyStatus @default(VALID)
  description    String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  Job            Job?
  Motorcycle     Motorcycle     @relation(fields: [motorcycleId], references: [id])
}

enum Role {
  CUSTOMER
  SERVICE_ADVISOR
  TECHNICIAN
  FOREMAN
  STOCK_KEEPER
  CASHIER
  MANAGER
  ADMIN
}

enum JobStatus {
  PENDING
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  PAID
  CANCELLED
}

enum JobType {
  NORMAL
  FAST_TRACK
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PartRequisitionStatus {
  PENDING
  APPROVED
  REJECTED
  ISSUED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  TRANSFER
  POINTS
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  REFUNDED
}

enum QuotationStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
  RETURN
}

enum WarrantyStatus {
  VALID
  EXPIRED
  VOID
}
